name: Application Deployment

on:
  workflow_run:
    workflows: ["CI Build and Test"]
    types:
      - completed
    branches: [ main ]  # Only deploy from main branch
  workflow_dispatch:
    inputs:
      environment:
        description: 'Environment to deploy to'
        required: true
        default: 'dev'
        type: choice
        options:
          - dev
          - test
          - prod

concurrency:
  group: deploy-${{ github.event.inputs.environment || 'dev' }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  deploy:
    runs-on: ubuntu-latest
    # Only deploy if: CI passed AND branch is main, OR manual trigger
    if: |
      (github.event.workflow_run.conclusion == 'success' && github.event.workflow_run.head_branch == 'main') ||
      github.event_name == 'workflow_dispatch'
    environment: ${{ github.event.inputs.environment || 'dev' }}
    
    permissions:
      id-token: write
      contents: read

    env:
      ENVIRONMENT: ${{ github.event.inputs.environment || 'dev' }}
      ACR_NAME: acrcvanalyzer${{ github.event.inputs.environment || 'dev' }}
      RESOURCE_GROUP: rg-cvanalyzer-${{ github.event.inputs.environment || 'dev' }}

    steps:
    - uses: actions/checkout@v4

    - name: Azure Login
      uses: azure/login@v2
      with:
        creds: ${{ secrets.AZURE_CREDENTIALS }}

    - name: ACR Login
      run: |
        az acr login --name ${{ env.ACR_NAME }}

    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v3

    - name: Build and Push Images
      run: |
        # Build and push images with both commit SHA and latest tags
        # Backend API
        docker build -t ${{ env.ACR_NAME }}.azurecr.io/cvanalyzer-api:${{ github.sha }} \
                     -t ${{ env.ACR_NAME }}.azurecr.io/cvanalyzer-api:latest \
                     ./backend &
        
        # Frontend
        docker build -t ${{ env.ACR_NAME }}.azurecr.io/cvanalyzer-frontend:${{ github.sha }} \
                     -t ${{ env.ACR_NAME }}.azurecr.io/cvanalyzer-frontend:latest \
                     ./frontend &
        
        wait
        
        # Push both tags for each image with error handling
        echo "Pushing images to ACR..."
        docker push ${{ env.ACR_NAME }}.azurecr.io/cvanalyzer-api:${{ github.sha }} || { echo "Failed to push API SHA tag"; exit 1; }
        docker push ${{ env.ACR_NAME }}.azurecr.io/cvanalyzer-api:latest || { echo "Failed to push API latest tag"; exit 1; }
        docker push ${{ env.ACR_NAME }}.azurecr.io/cvanalyzer-frontend:${{ github.sha }} || { echo "Failed to push Frontend SHA tag"; exit 1; }
        docker push ${{ env.ACR_NAME }}.azurecr.io/cvanalyzer-frontend:latest || { echo "Failed to push Frontend latest tag"; exit 1; }
        echo "✓ All images pushed successfully"

    - name: Update Container Apps
      run: |
        # Update both apps in parallel
        az containerapp update \
          --name ca-cvanalyzer-api \
          --resource-group ${{ env.RESOURCE_GROUP }} \
          --image ${{ env.ACR_NAME }}.azurecr.io/cvanalyzer-api:${{ github.sha }} &
        
        az containerapp update \
          --name ca-cvanalyzer-frontend \
          --resource-group ${{ env.RESOURCE_GROUP }} \
          --image ${{ env.ACR_NAME }}.azurecr.io/cvanalyzer-frontend:${{ github.sha }} &
        
        wait

    - name: Health Check
      run: |
        echo "Waiting for Container Apps revision provisioning (can take up to 20 minutes)..."
        
        API_URL=$(az containerapp show --name ca-cvanalyzer-api --resource-group ${{ env.RESOURCE_GROUP }} --query properties.configuration.ingress.fqdn -o tsv)
        FRONTEND_URL=$(az containerapp show --name ca-cvanalyzer-frontend --resource-group ${{ env.RESOURCE_GROUP }} --query properties.configuration.ingress.fqdn -o tsv)
        
        # Wait for revisions to reach Running state (up to 20 minutes)
        MAX_ATTEMPTS=40  # 40 × 30s = 20 minutes
        
        for i in $(seq 1 $MAX_ATTEMPTS); do
          API_REVISION=$(az containerapp show --name ca-cvanalyzer-api --resource-group ${{ env.RESOURCE_GROUP }} --query properties.latestRevisionName -o tsv)
          FRONTEND_REVISION=$(az containerapp show --name ca-cvanalyzer-frontend --resource-group ${{ env.RESOURCE_GROUP }} --query properties.latestRevisionName -o tsv)
          
          API_STATUS=$(az containerapp revision show --name ca-cvanalyzer-api --resource-group ${{ env.RESOURCE_GROUP }} --revision "$API_REVISION" --query properties.runningState -o tsv 2>/dev/null || echo "Unknown")
          FRONTEND_STATUS=$(az containerapp revision show --name ca-cvanalyzer-frontend --resource-group ${{ env.RESOURCE_GROUP }} --revision "$FRONTEND_REVISION" --query properties.runningState -o tsv 2>/dev/null || echo "Unknown")
          
          echo "[$i/$MAX_ATTEMPTS] API: $API_STATUS | Frontend: $FRONTEND_STATUS"
          
          if [ "$API_STATUS" == "Running" ] && [ "$FRONTEND_STATUS" == "Running" ]; then
            echo "✓ Both revisions are running, checking health endpoints..."
            sleep 15  # Wait for apps to fully initialize (DI, health checks, connections)
            
            # Health endpoint checks with 3 retries
            for j in 1 2 3; do
              API_HEALTH=$(curl -sf "https://$API_URL/api/health" && echo "OK" || echo "FAIL")
              FRONTEND_HEALTH=$(curl -sf "https://$FRONTEND_URL/health" && echo "OK" || echo "FAIL")
              
              if [ "$API_HEALTH" == "OK" ] && [ "$FRONTEND_HEALTH" == "OK" ]; then
                echo "[PASS] All health checks passed"
                echo "API_URL=$API_URL" >> $GITHUB_ENV
                echo "FRONTEND_URL=$FRONTEND_URL" >> $GITHUB_ENV
                exit 0
              fi
              
              echo "Health check retry $j/3: API=$API_HEALTH, Frontend=$FRONTEND_HEALTH"
              sleep 10
            done
            
            echo "[FAIL] Revisions running but health checks failed"
            echo "Fetching container logs for debugging..."
            
            echo "=== API Logs ==="
            az containerapp logs show \
              --name ca-cvanalyzer-api \
              --resource-group ${{ env.RESOURCE_GROUP }} \
              --tail 50 || echo "Could not fetch API logs"
            
            echo "=== Frontend Logs ==="
            az containerapp logs show \
              --name ca-cvanalyzer-frontend \
              --resource-group ${{ env.RESOURCE_GROUP }} \
              --tail 50 || echo "Could not fetch Frontend logs"
            
            exit 1
          fi
          
          if [ "$API_STATUS" == "Failed" ] || [ "$FRONTEND_STATUS" == "Failed" ]; then
            echo "[FAIL] Revision activation failed"
            echo "API Status: $API_STATUS"
            echo "Frontend Status: $FRONTEND_STATUS"
            exit 1
          fi
          
          sleep 30
        done
        
        echo "[FAIL] Timeout waiting for revisions to reach Running state"
        exit 1

    - name: Deployment Summary
      if: always()
      run: |
        echo "## Deployment Summary" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "**Environment:** ${{ env.ENVIRONMENT }}" >> $GITHUB_STEP_SUMMARY
        echo "**Git SHA:** ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
        echo "**Status:** ${{ job.status }}" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        
        if [ "${{ job.status }}" == "success" ]; then
          echo "**Result:** Deployment successful" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Deployed URLs:**" >> $GITHUB_STEP_SUMMARY
          echo "- Frontend: https://$FRONTEND_URL" >> $GITHUB_STEP_SUMMARY
          echo "- API: https://$API_URL" >> $GITHUB_STEP_SUMMARY
          echo "- API Health: https://$API_URL/api/health" >> $GITHUB_STEP_SUMMARY
        else
          echo "**Result:** Deployment failed" >> $GITHUB_STEP_SUMMARY
        fi