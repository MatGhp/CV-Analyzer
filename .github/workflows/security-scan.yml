name: Security - Secret Scanning

on:
  pull_request:
    branches: [ main ]
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  secret-scan:
    name: Scan for Secrets
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0  # Full history for better scanning
    
    - name: TruffleHog Secret Scan
      uses: trufflesecurity/trufflehog@main
      with:
        path: ./
        extra_args: --only-verified
    
    - name: GitLeaks Secret Scan
      uses: gitleaks/gitleaks-action@v2
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        GITLEAKS_LICENSE: ${{ secrets.GITLEAKS_LICENSE }} # Optional: for advanced features
    
    - name: Check for sensitive files
      run: |
        echo "ðŸ” Checking for sensitive files..."
        
        SENSITIVE_FILES=$(find . -type f \( \
          -name "*.env" \
          -o -name "*.secret" \
          -o -name "*.key" \
          -o -name "*credentials*" \
          -o -name "secrets.json" \
          -o -name "azureauth.json" \
        \) -not -path "*/node_modules/*" -not -path "*/.git/*" -not -path "*/bin/*" -not -path "*/obj/*")
        
        if [ ! -z "$SENSITIVE_FILES" ]; then
          echo "[FAIL] Sensitive files found:"
          echo "$SENSITIVE_FILES"
          exit 1
        else
          echo "[PASS] No sensitive files found"
        fi
    
    - name: Verify .gitignore coverage
      run: |
        echo "Verifying .gitignore patterns..."
        
        # Check critical patterns in .gitignore
        MISSING=$(grep -L -E '(\*\.env|\*\.secret|\*\.key|\*\.tfvars|secrets\.json)' .gitignore || echo "")
        
        if [ -n "$MISSING" ]; then
          echo "[WARNING] Some patterns may be missing in .gitignore"
        else
          echo "[PASS] Critical patterns found in .gitignore"
        fi
    
    - name: Scan for hardcoded IPs
      run: |
        echo "Scanning for private IP addresses..."
        
        if grep -rn --include="*.cs" --include="*.ts" --include="*.js" -E "192\.168\.|10\.|172\.(1[6-9]|2[0-9]|3[01])\." . --exclude-dir=node_modules > /dev/null 2>&1; then
          echo "[WARNING] Private IP addresses found (review recommended)"
        else
          echo "[PASS] No hardcoded private IPs detected"
        fi
    
    - name: Summary
      if: always()
      run: |
        echo "## Security Scan Summary" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "- [PASS] TruffleHog scan completed" >> $GITHUB_STEP_SUMMARY
        echo "- [PASS] GitLeaks scan completed" >> $GITHUB_STEP_SUMMARY
        echo "- [PASS] Sensitive file check completed" >> $GITHUB_STEP_SUMMARY
        echo "- [PASS] .gitignore verification completed" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "**Branch:** ${{ github.ref_name }}" >> $GITHUB_STEP_SUMMARY
        echo "**Commit:** ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
