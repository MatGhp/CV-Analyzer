<div class="analysis-container">
  <!-- Save Results Banner for Anonymous Users -->
  @if (!isLoading() && !errorMessage() && isAnonymous()) {
    <app-save-results-banner 
      [isAnonymous]="isAnonymous()"
      (onSaveClick)="handleSaveResults()"
    />
  }

  <!-- Loading State -->
  @if (isLoading()) {
    <div class="loading-section">
      <div class="spinner-large"></div>
      <h2>Analyzing Your Resume</h2>
      
      @if (status()) {
        <div class="progress-bar">
          <div 
            class="progress-fill" 
            [style.width.%]="status()!.progress"
          ></div>
        </div>
        <p class="status-text">
          {{ status()!.status | titlecase }} - {{ status()!.progress }}%
        </p>
      }
      
      <p class="loading-message">
        This may take up to 30 seconds. Please don't close this page.
      </p>
    </div>
  }

  <!-- Error State -->
  @if (errorMessage() && !isLoading()) {
    <div class="error-section">
      <div class="error-icon">⚠️</div>
      <h2>Analysis Failed</h2>
      <p>{{ errorMessage() }}</p>
      <div class="error-actions">
        <button class="btn btn-primary" (click)="retryAnalysis()">
          Retry Analysis
        </button>
        <button class="btn btn-outline" (click)="goToUpload()">
          Upload Another Resume
        </button>
      </div>
    </div>
  }

  <!-- Success State -->
  @if (analysis() && !isLoading()) {
    <div class="analysis-results" role="region" aria-label="Resume analysis results">
      <h1 class="results-title">Analysis Complete!</h1>

      <!-- Score and Summary Section -->
      <div class="score-section">
        <div class="score-badge" [class]="scoreClass()">
          <span class="score-value">{{ analysis()!.score || 0 }}</span>
          <span class="score-label">/ 100</span>
        </div>
      </div>

      <!-- Candidate Info Card -->
      @if (analysis()!.candidateInfo) {
        <app-candidate-info-card 
          [candidateInfo]="analysis()!.candidateInfo!"
        />
      }

    <!-- Suggestions Section -->
    <div class="suggestions-section">
      <h3 class="section-title">
        <svg class="icon-suggestions" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
            d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-3 7h3m-3 4h3m-6-4h.01M9 16h.01" />
        </svg>
        Suggestions for Improvement
      </h3>

      <!-- Group suggestions by category -->
      @for (category of suggestionsByCategory(); track category.name) {
        <div class="suggestion-category">
          <h4 class="category-name">{{ category.name }}</h4>
          <div class="suggestions-list">
            @for (suggestion of category.suggestions; track $index) {
              <div class="suggestion-card" [class]="'priority-' + suggestion.priority">
                <div class="suggestion-header">
                  <span class="priority-badge" [class]="'priority-' + suggestion.priority">
                    Priority {{ suggestion.priority }}
                  </span>
                </div>
                <p class="suggestion-text">{{ suggestion.description }}</p>
              </div>
            }
          </div>
        </div>
      }
    </div>

    <!-- Optimized Content Section (collapsible) -->
    @if (analysis()!.optimizedContent) {
      <div class="optimized-section">
        <button
          type="button"
          class="section-toggle"
          (click)="toggleOptimized()"
          [attr.aria-expanded]="showOptimized()">
          <h3 class="section-title">
            <svg class="icon-optimized" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
            </svg>
            Optimized Resume Content
          </h3>
          <svg
            class="icon-chevron"
            [class.rotated]="showOptimized()"
            fill="none"
            stroke="currentColor"
            viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" />
          </svg>
        </button>

        @if (showOptimized()) {
          <div class="optimized-content">
            <pre class="optimized-text">{{ analysis()!.optimizedContent }}</pre>
            <button
              type="button"
              class="btn btn-secondary"
              (click)="copyToClipboard()"
              [attr.aria-label]="copyButtonText()">
              <svg class="icon-copy" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                @if (copied()) {
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7" />
                } @else {
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                    d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z" />
                }
              </svg>
              <span>{{ copyButtonText() }}</span>
            </button>

            <!-- Copy error feedback -->
            @if (copyError()) {
              <div class="copy-error" role="alert">
                <svg class="icon-error" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                    d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                </svg>
                <span>{{ copyError() }}</span>
              </div>
            }
          </div>
        }
      </div>
    }

    <!-- Metadata Footer -->
    @if (analysis()!.metadata) {
      <div class="metadata-footer">
        @if (analysis()!.metadata!.analyzedAt) {
          <span class="metadata-item">
            <svg class="icon-meta" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z" />
            </svg>
            Analyzed {{ formatDate(analysis()!.metadata!.analyzedAt!) }}
          </span>
        }
        @if (analysis()!.metadata!.model) {
          <span class="metadata-item">
            <svg class="icon-meta" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                d="M9.663 17h4.673M12 3v1m6.364 1.636l-.707.707M21 12h-1M4 12H3m3.343-5.657l-.707-.707m2.828 9.9a5 5 0 117.072 0l-.548.547A3.374 3.374 0 0014 18.469V19a2 2 0 11-4 0v-.531c0-.895-.356-1.754-.988-2.386l-.548-.547z" />
            </svg>
            {{ analysis()!.metadata!.model }}
          </span>
        }
      </div>
    }

      <!-- Actions -->
      <div class="actions">
        <button
          type="button"
          class="btn btn-outline"
          (click)="goToUpload()">
          <svg class="icon-action" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
              d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-8l-4-4m0 0L8 8m4-4v12" />
          </svg>
          Upload Another Resume
        </button>
      </div>
    </div>
  }
</div>
